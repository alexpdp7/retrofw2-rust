From fd0b5728ff57357878274f60222c0bbe288e270f Mon Sep 17 00:00:00 2001
From: alex <alex@pdp7.net>
Date: Thu, 6 Feb 2020 17:42:30 +0100
Subject: [PATCH 12/12] sdl_mixer didn't build so I clobbered it with RetroFw's
 folder

---
 .../0002-add-LDFLAGS-while-linking.patch      | 24 +++++---
 .../0003-Fix-include-of-modplug.h.patch       | 33 -----------
 .../sdl_mixer/0003-hack-rs97_sdlmixer.patch   | 53 +++++++++++++++++
 package/sdl_mixer/0004-modpluginclude.patch   | 12 ++++
 .../sdl_mixer/0005-Fixwontbuildontremor.patch | 58 +++++++++++++++++++
 package/sdl_mixer/sdl_mixer.hash              |  3 -
 package/sdl_mixer/sdl_mixer.mk                | 41 ++++++-------
 7 files changed, 157 insertions(+), 67 deletions(-)
 delete mode 100644 package/sdl_mixer/0003-Fix-include-of-modplug.h.patch
 create mode 100644 package/sdl_mixer/0003-hack-rs97_sdlmixer.patch
 create mode 100644 package/sdl_mixer/0004-modpluginclude.patch
 create mode 100644 package/sdl_mixer/0005-Fixwontbuildontremor.patch
 delete mode 100644 package/sdl_mixer/sdl_mixer.hash

diff --git a/package/sdl_mixer/0002-add-LDFLAGS-while-linking.patch b/package/sdl_mixer/0002-add-LDFLAGS-while-linking.patch
index 4144660741..da781cab34 100644
--- a/package/sdl_mixer/0002-add-LDFLAGS-while-linking.patch
+++ b/package/sdl_mixer/0002-add-LDFLAGS-while-linking.patch
@@ -11,19 +11,25 @@ when -static is correctly passed in the linking step.
 
 Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
 
-diff -Nur SDL_mixer-1.2.12.orig/Makefile.in SDL_mixer-1.2.12/Makefile.in
---- SDL_mixer-1.2.12.orig/Makefile.in	2012-01-15 23:01:04.000000000 +0100
-+++ SDL_mixer-1.2.12/Makefile.in	2016-12-07 08:29:22.479786596 +0100
-@@ -66,10 +66,10 @@
- 	$(LIBTOOL) --mode=link $(CC) -o $@ $(OBJECTS) $(VERSION_OBJECTS) $(LDFLAGS) $(EXTRA_LDFLAGS) $(LT_LDFLAGS)
+Revised patch so it would also work with SDL_mixer 1.2.13
+
+diff -Nur SDL_mixer-1.2.13.orig/Makefile.in SDL_mixer-1.2.13/Makefile.in
+--- SDL_mixer-1.2.13.orig/Makefile.in	2012-01-15 23:01:04.000000000 +0100
++++ SDL_mixer-1.2.13/Makefile.in	2016-12-07 08:29:22.479786596 +0100
+@@ -63,13 +63,13 @@
+ .PHONY: all install install-hdrs install-lib install-bin uninstall uninstall-hdrs uninstall-lib uninstall-bin clean distclean dist
+ 
+ $(objects)/$(TARGET): $(OBJECTS) $(VERSION_OBJECTS)
+-	$(LIBTOOL) --mode=link $(CC) -o $@ $(OBJECTS) $(VERSION_OBJECTS) $(LDFLAGS) $(SDL_LIBS) $(EXTRA_LDFLAGS) $(LT_LDFLAGS)
++	$(LIBTOOL) --mode=link $(CC) -o $@ $(OBJECTS) $(VERSION_OBJECTS) $(LDFLAGS) $(SDL_LIBS) $(LDFLAGS) $(EXTRA_LDFLAGS) $(LT_LDFLAGS)
  
  $(objects)/playwave$(EXE): $(objects)/playwave.lo $(objects)/$(TARGET)
--	$(LIBTOOL) --mode=link $(CC) -o $@ $(objects)/playwave.lo $(SDL_CFLAGS) $(SDL_LIBS) $(objects)/$(TARGET)
-+	$(LIBTOOL) --mode=link $(CC) -o $@ $(objects)/playwave.lo $(SDL_CFLAGS) $(SDL_LIBS) $(LDFLAGS) $(objects)/$(TARGET)
+-	$(LIBTOOL) --mode=link $(CC) -o $@ $(objects)/playwave.lo $(SDL_CFLAGS) $(SDL_LIBS) $(LDFLAGS) $(objects)/$(TARGET)
++	$(LIBTOOL) --mode=link $(CC) -o $@ $(objects)/playwave.lo $(SDL_CFLAGS) $(SDL_LIBS) $(LDFLAGS) $(LDFLAGS) $(objects)/$(TARGET)
  
  $(objects)/playmus$(EXE): $(objects)/playmus.lo $(objects)/$(TARGET)
--	$(LIBTOOL) --mode=link $(CC) -o $@ $(objects)/playmus.lo $(SDL_CFLAGS) $(SDL_LIBS) $(objects)/$(TARGET)
-+	$(LIBTOOL) --mode=link $(CC) -o $@ $(objects)/playmus.lo $(SDL_CFLAGS) $(SDL_LIBS) $(LDFLAGS) $(objects)/$(TARGET)
+-	$(LIBTOOL) --mode=link $(CC) -o $@ $(objects)/playmus.lo $(SDL_CFLAGS) $(SDL_LIBS) $(LDFLAGS) $(objects)/$(TARGET)
++	$(LIBTOOL) --mode=link $(CC) -o $@ $(objects)/playmus.lo $(SDL_CFLAGS) $(SDL_LIBS) $(LDFLAGS) $(LDFLAGS) $(objects)/$(TARGET)
  
  install: all install-hdrs install-lib #install-bin
  install-hdrs:
diff --git a/package/sdl_mixer/0003-Fix-include-of-modplug.h.patch b/package/sdl_mixer/0003-Fix-include-of-modplug.h.patch
deleted file mode 100644
index 841cef4ef5..0000000000
--- a/package/sdl_mixer/0003-Fix-include-of-modplug.h.patch
+++ /dev/null
@@ -1,33 +0,0 @@
-From fb8e7c535a88838cc8ae364cd2a099df6316d3b0 Mon Sep 17 00:00:00 2001
-From: Paul Cercueil <paul@crapouillou.net>
-Date: Tue, 30 Apr 2019 23:12:15 +0200
-Subject: [PATCH] Fix include of modplug.h
-
-The include path should be <libmodplug/modplug.h>, since the library
-doesn't provide any specific include path in its pkg-config file.
-
-This patch was obtained from this bug report:
-https://bugzilla.libsdl.org/show_bug.cgi?id=4893
-
-Signed-off-by: Paul Cercueil <paul@crapouillou.net>
-
----
- music_modplug.h | 3 ++-
- 1 file changed, 2 insertions(+), 1 deletion(-)
-
-diff --git a/music_modplug.h b/music_modplug.h
-index 92cbafd..49abbb0 100644
---- a/music_modplug.h
-+++ b/music_modplug.h
-@@ -1,6 +1,7 @@
- #ifdef MODPLUG_MUSIC
- 
--#include "modplug.h"
-+#include <libmodplug/modplug.h>
-+
- #include "SDL_rwops.h"
- #include "SDL_audio.h"
- #include "SDL_mixer.h"
--- 
-2.21.0.593.g511ec345e18
-
diff --git a/package/sdl_mixer/0003-hack-rs97_sdlmixer.patch b/package/sdl_mixer/0003-hack-rs97_sdlmixer.patch
new file mode 100644
index 0000000000..052b29ed5c
--- /dev/null
+++ b/package/sdl_mixer/0003-hack-rs97_sdlmixer.patch
@@ -0,0 +1,53 @@
+diff -Nur a/mixer.c b/mixer.c
+--- a/mixer.c
++++ b/mixer.c
+@@ -420,6 +420,10 @@
+ 		}
+ 	}
+
++	if (format == AUDIO_S16 || format == AUDIO_S16MSB || format == AUDIO_S16SYS)
++		format = AUDIO_S16LSB;
++	Mix_Init(MIX_INIT_OGG|MIX_INIT_MOD);
++
+ 	/* Set the desired format and frequency */
+ 	desired.freq = frequency;
+ 	desired.format = format;
+@@ -476,6 +480,9 @@
+ 
+ 	audio_opened = 1;
+ 	SDL_PauseAudio(0);
++
++	Mix_Init(MIX_INIT_OGG|MIX_INIT_MOD);
++
+ 	return(0);
+ }
+
+@@ -551,6 +551,16 @@
+ 	return(audio_opened);
+ }
+ 
++Mix_Chunk *Mix_LoadWAV(const char *file) {
++  int retry = 50;
++  Mix_Chunk *wav = NULL;
++  do {
++    wav = Mix_LoadWAV_RW(SDL_RWFromFile(file, "rb"), 0);
++    if (wav != NULL) break;
++    SDL_Delay(50);
++  } while(retry--);
++  return wav;
++}
+ 
+ /*
+  * !!! FIXME: Ideally, we want a Mix_LoadSample_RW(), which will handle the
+
+diff -Naur a/SDL_mixer.h b/SDL_mixer.h
+--- a/SDL_mixer.h
++++ b/SDL_mixer.h
+@@ -147,7 +147,7 @@
+ 
+ /* Load a wave file or a music (.mod .s3m .it .xm) file */
+ extern DECLSPEC Mix_Chunk * SDLCALL Mix_LoadWAV_RW(SDL_RWops *src, int freesrc);
+-#define Mix_LoadWAV(file)	Mix_LoadWAV_RW(SDL_RWFromFile(file, "rb"), 1)
++extern DECLSPEC Mix_Chunk * SDLCALL Mix_LoadWAV(const char *file);
+ extern DECLSPEC Mix_Music * SDLCALL Mix_LoadMUS(const char *file);
+ 
diff --git a/package/sdl_mixer/0004-modpluginclude.patch b/package/sdl_mixer/0004-modpluginclude.patch
new file mode 100644
index 0000000000..8ab86d4c81
--- /dev/null
+++ b/package/sdl_mixer/0004-modpluginclude.patch
@@ -0,0 +1,12 @@
+diff -ru SDL_mixer-1.2.13.org/configure.in SDL_mixer-1.2.13/configure.in
+--- SDL_mixer-1.2.13.org/configure.in	2012-01-15 23:01:05.000000000 +0100
++++ SDL_mixer-1.2.13/configure.in	2014-07-03 05:25:44.761854572 +0200
+@@ -301,7 +301,7 @@
+         have_libmikmod=yes
+         AC_MSG_CHECKING([for libmikmod - version >= $libmikmod_ver])
+         AC_TRY_RUN([
+-#include "mikmod.h"
++#include "libmodplug/mikmod.h"
+ #include "stdio.h"
+ 
+ int main(int argc, char **argv)
diff --git a/package/sdl_mixer/0005-Fixwontbuildontremor.patch b/package/sdl_mixer/0005-Fixwontbuildontremor.patch
new file mode 100644
index 0000000000..d057301a95
--- /dev/null
+++ b/package/sdl_mixer/0005-Fixwontbuildontremor.patch
@@ -0,0 +1,58 @@
+--- a/configure.in
++++ a/configure.in
+@@ -449,7 +449,7 @@
+                 echo "-- dynamic libvorbisidec -> $ogg_lib"
+                 EXTRA_CFLAGS="$EXTRA_CFLAGS -DOGG_DYNAMIC=\\\"$ogg_lib\\\""
+             else
+-                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lvorbisidec -lvorbis"
++                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lvorbisidec "
+             fi
+         else
+             AC_MSG_WARN([*** Unable to find Ogg Vorbis Tremor library (http://www.xiph.org/)])
+@@ -457,7 +457,7 @@
+         fi
+     else
+         AC_CHECK_HEADER([vorbis/vorbisfile.h], [have_ogg_hdr=yes])
+-        AC_CHECK_LIB([vorbisfile], [ov_open_callbacks], [have_ogg_lib=yes], [], [-lvorbis -logg -lm])
++        AC_CHECK_LIB([vorbisfile], [ov_open_callbacks], [have_ogg_lib=yes], [], [ -logg -lm])
+         if test x$have_ogg_hdr = xyes -a x$have_ogg_lib = xyes; then
+             case "$host" in
+                 *-*-darwin*)
+@@ -479,7 +479,7 @@
+                 echo "-- dynamic libvorbisfile -> $ogg_lib"
+                 EXTRA_CFLAGS="$EXTRA_CFLAGS -DOGG_DYNAMIC=\\\"$ogg_lib\\\""
+             else
+-                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lvorbisfile -lvorbis -logg -lm"
++                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lvorbisfile  -logg -lm"
+             fi
+         else
+             AC_MSG_WARN([*** Unable to find Ogg Vorbis library (http://www.xiph.org/)])
+--- a/configure
++++ a/configure
+@@ -13936,7 +13936,7 @@
+                 echo "-- dynamic libvorbisidec -> $ogg_lib"
+                 EXTRA_CFLAGS="$EXTRA_CFLAGS -DOGG_DYNAMIC=\\\"$ogg_lib\\\""
+             else
+-                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lvorbisidec -lvorbis"
++                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lvorbisidec "
+             fi
+         else
+             { $as_echo "$as_me:$LINENO: WARNING: *** Unable to find Ogg Vorbis Tremor library (http://www.xiph.org/)" >&5
+@@ -14083,7 +14083,7 @@
+   $as_echo_n "(cached) " >&6
+ else
+   ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lvorbisfile -lvorbis -logg -lm $LIBS"
++LIBS="-lvorbisfile  -logg -lm $LIBS"
+ cat >conftest.$ac_ext <<_ACEOF
+ /* confdefs.h.  */
+ _ACEOF
+@@ -14167,7 +14167,7 @@
+                 echo "-- dynamic libvorbisfile -> $ogg_lib"
+                 EXTRA_CFLAGS="$EXTRA_CFLAGS -DOGG_DYNAMIC=\\\"$ogg_lib\\\""
+             else
+-                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lvorbisfile -lvorbis -logg -lm"
++                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lvorbisfile  -logg -lm"
+             fi
+         else
+             { $as_echo "$as_me:$LINENO: WARNING: *** Unable to find Ogg Vorbis library (http://www.xiph.org/)" >&5
diff --git a/package/sdl_mixer/sdl_mixer.hash b/package/sdl_mixer/sdl_mixer.hash
deleted file mode 100644
index 5d7e7836cd..0000000000
--- a/package/sdl_mixer/sdl_mixer.hash
+++ /dev/null
@@ -1,3 +0,0 @@
-# Locally calculated
-sha256	1644308279a975799049e4826af2cfc787cad2abb11aa14562e402521f86992a	SDL_mixer-1.2.12.tar.gz
-sha256	bc4c3bc32b311044d81c32b5e5402a6bc971a3b235850bb63445ec14bb6fe59e	COPYING
diff --git a/package/sdl_mixer/sdl_mixer.mk b/package/sdl_mixer/sdl_mixer.mk
index ab6f7ef014..e49c0fd522 100644
--- a/package/sdl_mixer/sdl_mixer.mk
+++ b/package/sdl_mixer/sdl_mixer.mk
@@ -4,52 +4,49 @@
 #
 ################################################################################
 
-SDL_MIXER_VERSION = 1.2.12
-SDL_MIXER_SOURCE = SDL_mixer-$(SDL_MIXER_VERSION).tar.gz
-SDL_MIXER_SITE = http://www.libsdl.org/projects/SDL_mixer/release
-SDL_MIXER_LICENSE = Zlib
+SDL_MIXER_VERSION = 1.2.13
+SDL_MIXER_SOURCE = SDL-1.2.tar.gz
+SDL_MIXER_SITE =  https://github.com/SDL-mirror/SDL_mixer/archive
+SDL_MIXER_LICENSE = zlib
 SDL_MIXER_LICENSE_FILES = COPYING
 
-# Package does not build in parallel due to improper make rules
-SDL_MIXER_MAKE = $(MAKE1)
-
 SDL_MIXER_INSTALL_STAGING = YES
 SDL_MIXER_DEPENDENCIES = sdl
-
-# We're patching configure.in, so we need to autoreconf
-SDL_MIXER_AUTORECONF = YES
-SDL_MIXER_AUTORECONF_OPTS = -Iacinclude
-
 SDL_MIXER_CONF_OPTS = \
 	--without-x \
 	--with-sdl-prefix=$(STAGING_DIR)/usr \
-	--disable-music-midi \
-	--disable-music-mod \
 	--disable-music-mp3 \
+	--disable-music-mod \
 	--disable-music-flac # configure script fails when cross compiling
 
-ifeq ($(BR2_PACKAGE_LIBMAD),y)
-SDL_MIXER_CONF_OPTS += --enable-music-mp3-mad-gpl
-SDL_MIXER_DEPENDENCIES += libmad
+ifeq ($(BR2_PACKAGE_MPG123),y)
+SDL_MIXER_CONF_OPTS += --enable-music-mp3
+SDL_MIXER_DEPENDENCIES += mpg123
 else
-SDL_MIXER_CONF_OPTS += --disable-music-mp3-mad-gpl
+SDL_MIXER_CONF_OPTS += --disable-music-mp3
 endif
 
+# Prefer libmikmod over Modplug due to dependency on C++
+ifeq ($(BR2_PACKAGE_LIBMIKMOD),y)
+SDL_MIXER_CONF_OPTS += --enable-music-mod
+SDL_MIXER_DEPENDENCIES += libmikmod
+else
 ifeq ($(BR2_PACKAGE_LIBMODPLUG),y)
 SDL_MIXER_CONF_OPTS += --enable-music-mod-modplug
-SDL_MIXER_DEPENDENCIES += host-pkgconf libmodplug
+SDL_MIXER_DEPENDENCIES += libmodplug
 else
 SDL_MIXER_CONF_OPTS += --disable-music-mod-modplug
 endif
+endif
 
+# prefer tremor over libvorbis
 ifeq ($(BR2_PACKAGE_TREMOR),y)
 SDL_MIXER_CONF_OPTS += --enable-music-ogg-tremor
 SDL_MIXER_DEPENDENCIES += tremor
-else ifeq ($(BR2_PACKAGE_LIBVORBIS),y)
-SDL_MIXER_CONF_OPTS += --enable-music-ogg
-SDL_MIXER_DEPENDENCIES += libvorbis
 else
 SDL_MIXER_CONF_OPTS += --disable-music-ogg
 endif
 
+SDL_MIXER_CONF_OPTS += --enable-music-timidity-midi
+
 $(eval $(autotools-package))
-- 
2.20.1

